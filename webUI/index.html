<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YouTube Archiver</title>
  <link rel="icon" href="app_icon.png" type="image/png">
  <link rel="apple-touch-icon" href="app_icon.png">
  <link rel="stylesheet" href="styles.css?v=1.3.0">
  <script defer src="app.js?v=1.3.0"></script>
</head>
<body>
  <div class="backdrop"></div>
  <header class="topbar">
    <div class="brand">
      <img class="app-icon" src="app_icon.png" alt="YouTube Archiver">
      <div class="brand-text">
        <div class="title">YouTube Archiver</div>
        <div class="subtitle">Self-hosted playlist archiving</div>
      </div>
    </div>
    <button id="nav-toggle" class="button ghost small nav-toggle" type="button" aria-expanded="false" aria-controls="primary-nav">
      Menu
    </button>
    <nav class="top-nav" id="primary-nav" aria-label="Primary">
      <button class="button ghost small nav-button" data-page="home" type="button">Home</button>
      <button class="button ghost small nav-button" data-page="config" type="button">Config</button>
      <button class="button ghost small nav-button" data-page="downloads" type="button">Downloads</button>
      <button class="button ghost small nav-button" data-page="history" type="button">History</button>
      <button class="button ghost small nav-button" data-page="logs" type="button">Logs</button>
      <div id="nav-actions" class="nav-actions"></div>
    </nav>
    <div class="top-actions" id="top-actions">
      <button id="refresh-all" class="button">Refresh</button>
      <button id="toggle-theme" class="button ghost">Light mode</button>
      <a class="button ghost" href="/docs" target="_blank" rel="noopener">OpenAPI</a>
    </div>
  </header>

  <main class="layout">
    <section class="panel" id="run-panel" data-page="home">
      <div class="panel-title">Run Controls</div>
      <div class="stack">
        <div class="group">
          <div class="group-title">Playlists</div>
          <div class="row">
            <button id="run-playlists" class="button">Run Playlists</button>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Single URL</div>
          <label class="field long">
            <span>Video URL</span>
            <input id="run-single-url" type="text" placeholder="https://www.youtube.com/watch?v=...">
          </label>
          <label class="field long gap-top">
            <span>Delivery</span>
            <div class="row delivery-options">
              <label class="radio">
                <input type="radio" name="run-delivery-mode" value="server" checked>
                <span>Save to server library</span>
              </label>
              <label class="radio">
                <input type="radio" name="run-delivery-mode" value="client">
                <span>Download to this device</span>
              </label>
            </div>
          </label>
          <label class="field medium gap-top">
            <span id="run-destination-label">Destination (single runs)</span>
            <div class="row">
              <input id="run-destination" type="text" placeholder="downloads">
              <button id="browse-run-destination" class="button ghost small" type="button">Browse</button>
            </div>
          </label>
        <div class="row">
          <label class="field short">
            <span>Format override</span>
            <select id="run-format">
              <option value="">(config default)</option>
              <option value="webm">webm</option>
              <option value="mp4">mp4</option>
              <option value="mkv">mkv</option>
              <option value="mp3">mp3</option>
            </select>
          </label>
          <label class="field medium">
            <span>JS runtime override</span>
            <input id="run-js-runtime" type="text" placeholder="node:/usr/bin/node">
          </label>
          <label class="field inline short">
            <span>Music mode</span>
            <input id="run-music-mode" type="checkbox">
          </label>
          </div>
        <div class="row">
          <button id="run-single" class="button">Run Single URL</button>
          <a id="run-single-download" class="button ghost small" href="#" aria-disabled="true">Download last</a>
        </div>
      </div>

        <div class="group">
          <div class="group-title">Single Playlist</div>
          <label class="field long">
            <span>Playlist URL or ID</span>
            <input id="run-playlist-id" type="text" placeholder="https://www.youtube.com/playlist?list=...">
          </label>
          <label class="field short gap-top">
            <span>Account (optional)</span>
            <input id="run-playlist-account" type="text" placeholder="account name from config">
          </label>
          <div class="row">
            <button id="run-playlist-once" class="button">Run Playlist Once</button>
          </div>
          <div class="notice">Uses the same destination and format overrides as single URL runs.</div>
        </div>

        <div id="run-message" class="notice" role="status"></div>
      </div>
    </section>

    <section class="panel" id="status-panel" data-page="home">
      <div class="panel-title">Status</div>
      <div class="stack">
        <div class="row">
          <span class="chip" id="status-running">idle</span>
          <span class="meta" id="status-run-id">run: -</span>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Started</span>
            <span id="status-started">-</span>
          </div>
          <div class="stat">
            <span class="label">Finished</span>
            <span id="status-finished">-</span>
          </div>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Success</span>
            <span id="status-success">0</span>
          </div>
          <div class="stat">
            <span class="label">Failed</span>
            <span id="status-failed">0</span>
          </div>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Watcher</span>
            <span id="status-watcher">-</span>
          </div>
          <div class="stat">
            <span class="label">Scheduler</span>
            <span id="status-scheduler">-</span>
          </div>
        </div>
        <div class="group">
          <div class="group-title">Watcher Status</div>
          <div class="row">
            <div class="stat">
              <span class="label">State</span>
              <span id="watcher-state">-</span>
            </div>
            <div class="stat">
              <span class="label">Pending playlists</span>
              <span id="watcher-pending">0</span>
            </div>
            <div class="stat">
              <span class="label">Batch mode</span>
              <span id="watcher-batch">-</span>
            </div>
          </div>
          <div class="row">
            <div class="stat">
              <span class="label">Last playlist check</span>
              <span id="watcher-last-poll">-</span>
            </div>
            <div class="stat">
              <span class="label">Next playlist check</span>
              <span id="watcher-next-poll">-</span>
            </div>
          </div>
          <div class="row">
            <div class="stat">
              <span class="label">Quiet window remaining</span>
              <span id="watcher-quiet-remaining">-</span>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Active playlist</span>
            <span id="status-playlist">-</span>
          </div>
          <div class="stat">
            <span class="label">Active video</span>
            <span id="status-video">-</span>
          </div>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Phase</span>
            <span id="status-phase">-</span>
          </div>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Last completed</span>
            <span id="status-last-completed">-</span>
          </div>
          <div class="stat">
            <span class="label">Playlist progress</span>
            <span id="status-playlist-progress-text">-</span>
          </div>
        </div>
        <div class="progress">
          <div id="status-playlist-progress-bar" class="progress-bar"></div>
        </div>
        <div id="status-video-progress" class="stack hidden">
          <div class="row">
            <div class="stat">
              <span class="label">Video progress</span>
              <span id="status-video-progress-text">-</span>
            </div>
            <span id="status-video-progress-meta" class="meta">-</span>
          </div>
          <div class="progress">
            <div id="status-video-progress-bar" class="progress-bar"></div>
          </div>
        </div>
        <div class="row">
          <span class="label">Last error</span>
          <span id="status-error" class="meta">-</span>
        </div>
        <div class="row">
          <button id="status-cancel" class="button remove small" type="button">Kill downloads in progress</button>
        </div>
      </div>
    </section>

    <section class="panel subtle" id="schedule-panel" data-page="home">
      <div class="panel-title">Optional bulk run scheduler</div>
      <div class="stack">
        <div class="row">
          <label class="field inline">
            <span>Enabled</span>
            <input id="schedule-enabled" type="checkbox">
          </label>
          <label class="field inline short">
            <span>Interval (hours)</span>
            <input id="schedule-interval" type="number" min="1" step="1" value="6">
          </label>
          <label class="field inline">
            <span>Run on startup</span>
            <input id="schedule-startup" type="checkbox">
          </label>
        </div>
        <div class="row">
          <button id="schedule-save" class="button">Save Schedule</button>
          <button id="schedule-run-now" class="button ghost">Run now</button>
          <div id="schedule-message" class="notice" role="status"></div>
        </div>
        <div class="row">
          <div class="stat">
            <span class="label">Last run</span>
            <span id="schedule-last-run">-</span>
          </div>
          <div class="stat">
            <span class="label">Next run</span>
            <span id="schedule-next-run">-</span>
          </div>
        </div>
        <div class="notice">Runs full playlist jobs on a fixed interval. Not required when watcher is enabled.</div>
        <div id="schedule-watcher-note" class="notice" style="display: none;">Watcher is active. Scheduler is optional and usually unnecessary.</div>
        <div class="notice">Scheduled runs will not interrupt or overlap manual runs.</div>
      </div>
    </section>

    <section class="panel" id="metrics-panel" data-page="home">
      <div class="panel-title">Metrics</div>
      <div class="panel-body">
        <div class="row">
          <div class="stat">
            <span class="label">Downloads files</span>
            <span id="metrics-downloads-count">-</span>
          </div>
          <div class="stat">
            <span class="label">Downloads size</span>
            <span id="metrics-downloads-size">-</span>
          </div>
          <div class="stat">
            <span class="label">Disk free</span>
            <span id="metrics-disk-free">-</span>
          </div>
          <div class="stat">
            <span class="label">Disk total</span>
            <span id="metrics-disk-total">-</span>
          </div>
        </div>
        <div class="row">
          <span id="metrics-message" class="notice"></span>
        </div>
      </div>
      <div class="panel-footer">
        <div class="row version-block">
          <div class="stat">
            <span class="label">Version</span>
            <div class="meta">
              <div id="status-version-app">App -</div>
              <div id="status-version-ytdlp">yt-dlp -</div>
              <div id="status-version-python">Py -</div>
            </div>
          </div>
          <div class="stat">
            <span class="label">Update</span>
            <span id="status-update" class="meta">-</span>
          </div>
        </div>
      </div>
    </section>

    <section class="panel full" id="config-panel" data-page="config">
      <div class="panel-title">Config Editor</div>
      <div class="stack">
        <div class="group">
          <div class="group-title">Config File</div>
          <div class="row">
            <label class="field long">
              <span>Config path (server)</span>
              <input id="config-path" type="text" placeholder="config/config.json">
            </label>
            <button id="browse-config-path" class="button ghost">Browse</button>
            <button id="load-config-path" class="button">Load</button>
          </div>
          <div class="notice">Path changes apply globally on the server.</div>
        </div>

        <div class="group">
          <div class="group-title">General</div>
          <div class="grid two">
            <label class="field short">
              <span>Upload date format</span>
              <input id="cfg-upload-date-format" type="text" placeholder="MM-YYYY">
            </label>
            <label class="field full">
              <span>Filename template</span>
              <input id="cfg-filename-template" type="text" placeholder="%(title)s - %(uploader)s - %(upload_date)s.%(ext)s">
            </label>
            <label class="field short">
              <span>Final format</span>
              <select id="cfg-final-format">
                <option value="">(not set)</option>
                <option value="webm">webm (default)</option>
                <option value="mp4">mp4</option>
                <option value="mkv">mkv</option>
                <option value="mp3">mp3</option>
              </select>
            </label>
            <label class="field medium">
              <span>JS runtime</span>
              <input id="cfg-js-runtime" type="text" placeholder="node:/usr/bin/node">
            </label>
            <label class="field medium">
              <span>Single download folder</span>
              <div class="row">
                <input id="cfg-single-download-folder" type="text" placeholder="downloads">
                <button id="browse-single-download" class="button ghost small">Browse</button>
              </div>
            </label>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Watcher</div>
          <div class="grid two">
            <label class="field inline short">
              <span>Enabled</span>
              <input id="cfg-watcher-enabled" type="checkbox">
            </label>
            <label class="field short">
              <span>Min interval (minutes)</span>
              <input id="cfg-watcher-min-interval" type="number" min="1" step="1">
            </label>
            <label class="field short">
              <span>Max interval (minutes)</span>
              <input id="cfg-watcher-max-interval" type="number" min="1" step="1">
            </label>
            <label class="field short">
              <span>Idle backoff factor</span>
              <input id="cfg-watcher-idle-backoff" type="number" min="1" step="1">
            </label>
            <label class="field short">
              <span>Active reset (minutes)</span>
              <input id="cfg-watcher-active-reset" type="number" min="1" step="1">
            </label>
            <label class="field inline short">
              <span>Downtime enabled</span>
              <input id="cfg-watcher-downtime-enabled" type="checkbox">
            </label>
            <label class="field short">
              <span>Downtime start (HH:MM)</span>
              <input id="cfg-watcher-downtime-start" type="text" placeholder="23:00">
            </label>
            <label class="field short">
              <span>Downtime end (HH:MM)</span>
              <input id="cfg-watcher-downtime-end" type="text" placeholder="09:00">
            </label>
            <label class="field medium">
              <span>Downtime timezone</span>
              <input id="cfg-watcher-downtime-timezone" type="text" placeholder="local">
            </label>
          </div>
          <div class="notice">Automatically monitors playlists and downloads new videos as they appear.</div>
        </div>

        <div class="group">
          <div class="group-title">Telegram</div>
          <div class="grid two">
            <label class="field long">
              <span>Bot token</span>
              <div class="row">
                <input id="cfg-telegram-token" type="password">
                <button id="toggle-telegram-token" class="button ghost small" type="button">Show</button>
              </div>
            </label>
            <label class="field short">
              <span>Chat ID</span>
              <input id="cfg-telegram-chat" type="text">
            </label>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Music</div>
          <div class="grid two">
            <label class="field full">
              <span>Music filename template</span>
              <input id="cfg-music-template" type="text" placeholder="%(artist)s/%(album)s/%(track_number)s - %(track)s.%(ext)s">
            </label>
            <label class="field long">
              <span>yt-dlp cookies (optional)</span>
              <div class="row">
                <input id="cfg-yt-dlp-cookies" type="text" placeholder="tokens/cookies.txt">
                <button id="browse-yt-dlp-cookies" class="button ghost small" type="button">Browse</button>
              </div>
            </label>
          </div>
          <div class="notice">Cookies are optional but strongly recommended for YouTube Music metadata.</div>
        </div>

        <div class="group">
          <div class="group-title">Music metadata enrichment</div>
          <div class="grid two">
            <label class="field inline short">
              <span>Enabled</span>
              <input id="cfg-music-meta-enabled" type="checkbox">
            </label>
            <label class="field short">
              <span>Confidence threshold</span>
              <input id="cfg-music-meta-threshold" type="number" min="0" max="100" step="1">
            </label>
            <label class="field inline short">
              <span>Use AcoustID</span>
              <input id="cfg-music-meta-acoustid" type="checkbox">
            </label>
            <label class="field long">
              <span>AcoustID API key</span>
              <input id="cfg-music-meta-acoustid-key" type="password" placeholder="optional">
            </label>
            <label class="field inline short">
              <span>Embed artwork</span>
              <input id="cfg-music-meta-artwork" type="checkbox">
            </label>
            <label class="field inline short">
              <span>Overwrite existing tags</span>
              <input id="cfg-music-meta-overwrite" type="checkbox">
            </label>
            <label class="field short">
              <span>Max artwork size (px)</span>
              <input id="cfg-music-meta-artwork-size" type="number" min="200" step="50">
            </label>
            <label class="field short">
              <span>Rate limit (seconds)</span>
              <input id="cfg-music-meta-rate" type="number" min="0" step="0.1">
            </label>
            <label class="field inline short">
              <span>Dry-run tagging</span>
              <input id="cfg-music-meta-dry-run" type="checkbox">
            </label>
          </div>
          <div class="notice">Applies only to music mode runs. Enrichment happens after downloads, in the background.</div>
        </div>

        <div class="group">
          <div class="group-title">Accounts</div>
          <div id="accounts-list" class="stack"></div>
          <button id="add-account" class="button ghost">Add account</button>
        </div>

        <div class="group">
          <div class="group-title">Playlists</div>
          <div id="playlists-list" class="stack"></div>
          <button id="add-playlist" class="button ghost">Add playlist</button>
        </div>

        <div class="group">
          <div class="group-title">yt-dlp Options (JSON)</div>
          <label class="field full">
            <span>Options</span>
            <textarea id="cfg-yt-dlp-opts" rows="6" placeholder='{"format_sort": ["res", "codec"]}'></textarea>
          </label>
        </div>

        <div class="group">
          <div class="group-title">Maintenance</div>
          <div class="row">
            <button id="ytdlp-update" class="button ghost">Update yt-dlp</button>
            <div id="ytdlp-update-message" class="notice" role="status"></div>
          </div>
        </div>

        <div class="row">
          <button id="save-config" class="button">Save Config</button>
          <button id="reset-config" class="button ghost">Reset</button>
          <div id="config-message" class="notice" role="status"></div>
        </div>
      </div>
    </section>

    <section class="panel full page-full" id="logs-panel" data-page="logs">
      <div class="panel-title">Logs</div>
      <div class="row">
        <label class="field inline short">
          <span>Lines</span>
          <input id="logs-lines" type="number" min="1" max="5000" value="200">
        </label>
        <button id="logs-refresh" class="button ghost">Refresh</button>
        <label class="field inline">
          <span>Auto</span>
          <input id="logs-auto" type="checkbox" checked>
        </label>
      </div>
      <pre id="logs-output" class="log-output" aria-live="polite"></pre>
    </section>

    <section class="panel full page-full" id="downloads-panel" data-page="downloads">
      <div class="panel-title">Downloads</div>
      <div class="row">
        <button id="downloads-refresh" class="button ghost">Refresh</button>
        <button id="cleanup-temp" class="button ghost">Clear temporary files</button>
        <div id="downloads-message" class="notice" role="status"></div>
      </div>
      <div class="row">
        <button class="button ghost small filters-toggle" data-target="downloads-filters" type="button">Filters</button>
      </div>
      <div class="filters-block" id="downloads-filters">
        <div class="row filters">
          <label class="field inline long">
            <span>Search</span>
            <input id="downloads-search" type="text" placeholder="name or path">
          </label>
          <label class="field inline short">
            <span>Limit</span>
            <input id="downloads-limit" type="number" min="1" max="5000" value="50">
          </label>
          <button id="downloads-apply" class="button ghost">Apply</button>
          <button id="downloads-clear" class="button ghost">Clear</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Modified</th>
              <th>Size</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="downloads-body"></tbody>
        </table>
      </div>
    </section>

    <section class="panel full page-full" id="history-panel" data-page="history">
      <div class="panel-title">History</div>
      <div class="row">
        <button class="button ghost small filters-toggle" data-target="history-filters" type="button">Filters</button>
        <button id="history-refresh" class="button ghost">Refresh</button>
      </div>
      <div class="filters-block" id="history-filters">
        <div class="row filters">
          <label class="field inline long">
            <span>Search</span>
            <input id="history-search" type="text" placeholder="title or filename">
          </label>
          <label class="field inline medium">
            <span>Playlist</span>
            <input id="history-playlist" type="text" placeholder="playlist id">
          </label>
          <label class="field inline short">
            <span>From</span>
            <input id="history-from" type="date">
          </label>
          <label class="field inline short">
            <span>To</span>
            <input id="history-to" type="date">
          </label>
        </div>
        <div class="row filters">
          <label class="field inline short">
            <span>Limit</span>
            <input id="history-limit" type="number" min="1" max="5000" value="50">
          </label>
          <label class="field inline short">
            <span>Sort</span>
            <select id="history-sort">
              <option value="date">date</option>
              <option value="title">title</option>
              <option value="size">size</option>
            </select>
          </label>
          <label class="field inline short">
            <span>Dir</span>
            <select id="history-dir">
              <option value="desc">desc</option>
              <option value="asc">asc</option>
            </select>
          </label>
          <label class="field inline short">
            <span>Internal paths</span>
            <input id="history-show-paths" type="checkbox">
          </label>
          <button id="history-apply" class="button ghost">Apply</button>
          <button id="history-clear" class="button ghost">Clear</button>
        </div>
      </div>
      <div id="history-message" class="notice" role="status"></div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Video ID</th>
              <th>Playlist ID</th>
              <th>Downloaded At</th>
              <th>Filepath</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="browser-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="browser-title">
    <div class="modal-card">
      <div class="row space-between">
        <div id="browser-title" class="panel-title">Server Browser</div>
        <button id="browser-close" class="button ghost small">Close</button>
      </div>
      <div class="row space-between">
        <div class="meta" id="browser-path">/</div>
        <button id="browser-up" class="button ghost small">Up</button>
      </div>
      <div id="browser-list" class="browser-list"></div>
      <div class="row space-between">
        <div class="meta" id="browser-selected">No selection</div>
        <button id="browser-select" class="button small">Use this path</button>
      </div>
    </div>
  </div>

  <div id="oauth-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="oauth-title">
    <div class="modal-card">
      <div class="row space-between">
        <div id="oauth-title" class="panel-title">OAuth Helper</div>
        <button id="oauth-close" class="button ghost small">Close</button>
      </div>
      <div class="stack">
        <div class="notice">Open the authorization URL, approve access, then paste the code below.</div>
        <div class="row">
          <span class="label">Account</span>
          <span id="oauth-account" class="meta">-</span>
        </div>
        <label class="field long">
          <span>Authorization URL</span>
          <div class="row">
            <input id="oauth-url" type="text" readonly>
            <button id="oauth-open" class="button ghost small" type="button">Open</button>
          </div>
        </label>
        <label class="field medium">
          <span>Authorization code</span>
          <input id="oauth-code" type="text" placeholder="Paste the code here">
        </label>
        <div class="row">
          <button id="oauth-complete" class="button">Complete OAuth</button>
          <div id="oauth-message" class="notice" role="status"></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
